---
title: "GitLabã¨Pythonã§å®Ÿç¾ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ–ãƒƒã‚¯é™³è…åŒ–é˜²æ­¢ï¼è‡ªå‹•æ£šå¸ã—ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ—„ï¸"
type: "tech" 
topics: [python,git,gitlab,hugo,ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]
published: true
published_at: 2024-11-06 06:00
publication_name: "secondselection"
---

## ã¯ã˜ã‚ã«

ç¤¾å†…ã§ã¯`hugo`ã¨`GitLab Pages`ã‚’ä½¿ã£ã¦[GitLab Handbook](https://handbook.gitlab.com/)ã«å€£ã£ã¦ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆãƒãƒ³ãƒ‰ãƒ–ãƒƒã‚¯ï¼‰ã‚’é‹ç”¨ã—ã¦ã„ã¾ã™ã€‚
ç¤¾å†…ã®ãƒãƒ³ãƒ‰ãƒ–ãƒƒã‚¯ã‚„ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚¬ã‚¤ãƒ‰ãªã©ã‚’é‹ç”¨ã—ã¦ã„ã‚‹ã¨ã€æ™‚é–“ã¨ã¨ã‚‚ã«å†…å®¹ãŒå¤ããªã‚Šæ°—ã¥ã‘ã°ã€Œã“ã‚Œã£ã¦ä»Šã‚‚ä½¿ãˆã‚‹ã®ï¼Ÿã€ã¨ã„ã£ãŸå•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚‚å¤šã„ã§ã™ã€‚
ãã®ãŸã‚ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†ã«ãŠã„ã¦**æƒ…å ±ã®é™³è…åŒ–**ã¯é¿ã‘ã‚‰ã‚Œãªã„èª²é¡Œã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€**GitLabä¸Šã®Markdownãƒ•ã‚¡ã‚¤ãƒ«**ã‚’å¯¾è±¡ã«ã€3ãƒ¶æœˆä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’è‡ªå‹•ã§æ´—ã„å‡ºã—ã€ã€Œæ£šå¸ã—å¯¾è±¡ã€ã¨ã—ã¦ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€å®šæœŸçš„ãªç¢ºèªã®æ‰‹é–“ã‚’çœããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ–°é®®ã•ã‚’ä¿ã¤ãŸã‚ã®ã‚µãƒãƒ¼ãƒˆã‚’ã—ã¦ãã‚Œã¾ã™ã€‚

## ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ¦‚è¦

ä»Šå›ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®2ã¤ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

- **ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚æ›´æ–°æ—¥ã‚’å–å¾—**
    - Gitãƒªãƒã‚¸ãƒˆãƒªå†…ã®`content/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.md`æ‹¡å¼µå­ï¼‰ã«ã¤ã„ã¦ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆæ—¥ã‚’å–å¾—ã—ã€æ›´æ–°æ—¥ãŒå¤ã„é †ã«ä¸¦ã¹ã¾ã™ã€‚
- **GitLabä¸Šã«æ£šå¸ã—ç”¨Issueã‚’è‡ªå‹•ç”Ÿæˆ**
    - å–å¾—ã—ãŸæ›´æ–°æ—¥ã‚’ã‚‚ã¨ã«ã€3ãƒ¶æœˆä»¥ä¸Šæ›´æ–°ã®ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€Œæ£šå¸å¯¾è±¡ã€ã®ã‚¿ã‚°ã‚’ä»˜ä¸ã—ã€GitLabä¸Šã«Issueã¨ã—ã¦ä¸€è¦§è¡¨ã‚’ä½œæˆã—ã¾ã™ã€‚

## ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è©³ç´°

ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚å„é–¢æ•°ã®å½¹å‰²ã«ã¤ã„ã¦é †ã‚’è¿½ã£ã¦è§£èª¬ã—ã¾ã™ã€‚

```txt: å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª
python-gitlab
```

```python: ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(inventory.py)
import gitlab
from os import getenv
import subprocess
from datetime import (
    datetime,
    timedelta
)

URL = getenv("GITLAB_URL")
TOKEN = {"private_token": getenv("GITLAB_TOKEN")}
PROJECT_ID = getenv("CI_PROJECT_ID")

target_dir = 'content/'
target_file = '.md'


def get_files_by_commit_date():
    # ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
    result = subprocess.run(
        ["git", "ls-files", target_dir],
        capture_output=True,
        text=True,
        check=True
    )
    
    # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆæ—¥ã‚’è¾æ›¸ã«æ ¼ç´
    file_dates = {}
    files = result.stdout.splitlines()
    for file in files:
        if file.endswith(target_file):  # content/ ä»¥ä¸‹ã® .md ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å¯¾è±¡ã«
            # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆæ—¥ã‚’å–å¾—
            log_result = subprocess.run(
                ["git", "log", "-1", "--pretty=format:%at", file],
                capture_output=True,
                text=True,
                check=True
            )
            timestamp = int(log_result.stdout.strip())
            file_dates[file] = timestamp

    # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆã—ã€yyyy-mm-ddå½¢å¼ã«å¤‰æ›ã—ãŸé€£æƒ³é…åˆ—ã‚’è¿”ã™
    sorted_files = {
        file: datetime.fromtimestamp(timestamp)
        for file, timestamp in sorted(file_dates.items(), key=lambda x: x[1])
    }
    
    return sorted_files


def create_gitlab_issue(files_by_commit_date):
    # 3ãƒµæœˆå‰ã®æ—¥ä»˜ã‚’è¨ˆç®—
    three_months_ago = datetime.now() - timedelta(days=90)

    # è¡¨å½¢å¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ
    issue_description = "| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ | æœ€çµ‚æ›´æ–°æ—¥ | è£œè¶³ |\n"
    issue_description += "|-----------|------------------|-----------|\n"
    for file, date in files_by_commit_date.items():
        # 3ãƒµæœˆä»¥ä¸Šæ›´æ–°ãŒãªã„å ´åˆã«ã€Œæ£šå¸å¯¾è±¡ã§ã™ã€ã‚’è¿½åŠ 
        notes = "æ£šå¸å¯¾è±¡ï¼š æœªå¯¾å¿œ/ä¸è¦/æ›´æ–°" if date < three_months_ago else ""
        issue_description += f"| {file} | {date.strftime('%Y-%m-%d')} | {notes} |\n"

    # GitLabãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å–å¾—
    gl = gitlab.Gitlab(URL, **TOKEN)
    project = gl.projects.get(PROJECT_ID)

    # GitLab Issueã®ä½œæˆ
    issue = project.issues.create({
        'title': 'ã€{}ã€‘æ£šå¸ãƒã‚§ãƒƒã‚¯'.format(
            datetime.now().strftime('%Yå¹´%mæœˆ')
        ),
        'description': issue_description
    })
    print("Issue created successfully:", issue.web_url)


if __name__ == "__main__":
    files_by_commit_date = get_files_by_commit_date()
    create_gitlab_issue(files_by_commit_date)

```

### 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚æ›´æ–°æ—¥ã‚’å–å¾—ã™ã‚‹ `get_files_by_commit_date` é–¢æ•°

ã“ã®é–¢æ•°ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªå†…ã®`content/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®`.md`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆæ—¥ã‚’å–å¾—ã—ã¾ã™ã€‚å–å¾—ã—ãŸã‚³ãƒŸãƒƒãƒˆæ—¥ã‚’ã‚‚ã¨ã«ã€æ›´æ–°æ—¥ãŒå¤ã„é †ã«ä¸¦ã³æ›¿ãˆãŸè¾æ›¸å½¢å¼ã§è¿”ã—ã¾ã™ã€‚

### 2. GitLabä¸Šã«æ£šå¸ã—Issueã‚’ä½œæˆã™ã‚‹ `create_gitlab_issue` é–¢æ•°

`get_files_by_commit_date` é–¢æ•°ã§å–å¾—ã—ãŸæƒ…å ±ã‚’ä½¿ã£ã¦ã€3ãƒ¶æœˆä»¥ä¸Šæ›´æ–°ãŒãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œæ£šå¸å¯¾è±¡ã€ã¨ã—ã¦ã‚¿ã‚°ã‚’ä»˜ã‘ã€GitLabä¸Šã«Issueã‚’ä½œæˆã—ã¾ã™ã€‚Issueã«ã¯ã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚„æœ€çµ‚æ›´æ–°æ—¥ãŒè¡¨å½¢å¼ã§è¨˜è¼‰ã•ã‚Œã¾ã™ã€‚

## ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€GitLab APIã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ã§ã™ã€‚

- `GITLAB_URL`: GitLabã®URL
- `GITLAB_TOKEN`: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒˆãƒ¼ã‚¯ãƒ³
- `CI_PROJECT_ID`: å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ID

ã“ã‚Œã‚‰ã®å¤‰æ•°ã‚’é©åˆ‡ã«è¨­å®šã—ã€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚„ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

## CIã®è¨­å®š

GitLabã§CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```yaml: .gitlab-ci.yml
inventory:
  image: python:3.12
  stage: schedule
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - pip install python-gitlab
  script:
    - python inventory.py
  tags:
    - scheduled
```

## ãŠã‚ã‚Šã«

æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚Šã€å®šæœŸçš„ã«æ›´æ–°ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ã§ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã€GitLabä¸Šã«æ£šå¸ã—ãƒã‚§ãƒƒã‚¯ç”¨ã®Issueã‚’ä½œæˆã§ãã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€æƒ…å ±ã®é™³è…åŒ–ã‚’é˜²ããŸã‚ã®å®šæœŸçš„ãªç¢ºèªã®æ‰‹é–“ã‚’çœããƒãƒ³ãƒ‰ãƒ–ãƒƒã‚¯ã®æ–°é®®ã•ã‚’ä¿ã¤ã‚µãƒãƒ¼ãƒˆãŒã§ãã¾ã™ã€‚

ãœã²ã€ã”è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚‚å°å…¥ã—ã¦ã€ãƒãƒ³ãƒ‰ãƒ–ãƒƒã‚¯ã®é®®åº¦ã‚’ä¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼
